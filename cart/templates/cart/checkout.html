{% extends 'layout.html' %}

{% block content %}

    <div class="container shadow bg-white pt-7 py-5">
        <div class="row mb-4">
            <div class="col-lg-8 mx-auto text-center">
                <h1 class="display-6">Payment</h1>
            </div>
        </div>
        <div class="row">
            {% csrf_token %}
            <div class="col-lg-6 mx-auto bg-white">
                <form action="{% url 'orderComplete' %}" id="myCartForm">
                    <div class="card shadow">
                        <div class="card-header bg-white shadow">
                            <div class="bg-white shadow-sm pt-4 pl-2 pr-2 pb-2">

                                <ul role="tablist" class="nav bg-light nav-pills rounded nav-fill mb-3">
                                    <li class="nav-item"><a data-toggle="pill" href="#wallet" class="nav-link active ">
                                        <i
                                                class="fas fa-wallet mr-2"></i> Wallet </a></li>

                                    <li class="nav-item"><a data-toggle="pill" href="#paypal-container"
                                                            class="nav-link ">
                                        <i
                                                class="fab fa-paypal mr-2"></i> Paypal </a></li>
                                </ul>
                            </div>
                            <div class="tab-content">

                                <!-- Wallet transfer info -->
                                <div id="wallet" class="tab-pane fade show active pt-3">
                                    <div class="form-group "><label for="Select Your Bank">
                                        <h6>Select your Wallet</h6>
                                    </label> <select class="form-control" id="ccmonth">
                                        <option value="" selected disabled>--Please select your Wallet--</option>
                                        <option>Esewa</option>
                                        <option>Khalti</option>
                                    </select></div>

                                    <div class="shadow m-auto container m-3 p-3 mb-5">
                                        <h4 class="m-auto">Total Amount to Pay: <span
                                                class="text-success">NPR {{ total_amount }}</span></h4>
                                    </div>

                                    <div class="form-group mt-3">
                                        <p>
                                            <a class="btn btn-primary " id="payment-button"><i
                                                    class="fas fa-wallet"></i>
                                                Pay with Khalti
                                            </a>
                                        </p>
                                    </div>
                                    <p class="text-muted">Note: After clicking on the button, you will be directed to a
                                        secure
                                        gateway for payment. After completing the payment process, you will be
                                        redirected
                                        back
                                        to
                                        the website. </p>

                                </div> <!-- End Esewa khalti -->

                                <!-- Paypal information code -->
                                <div id="paypal-container" class="tab-pane fade pt-3">
                                    <div class="shadow m-auto container m-3 p-3 mb-5">
                                        <h4 class="m-auto">Total Amount to Pay: <span
                                                class="text-success">NPR {{ total_amount }}</span></h4>
                                    </div>
                                    <!-- Set up a container element for the button -->
                                    <div id="paypal-button-container" class="mt-3"></div>

                                    <p class="text-muted mt-4"> Note: After clicking on the button, you will be directed
                                        to
                                        a
                                        secure
                                        gateway for payment. After completing the payment process, you will be
                                        redirected
                                        back
                                        to
                                        the website. </p>

                                </div> <!-- End paypal -->
                                <!-- End -->
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>



    <script>
        function verifyKhaltiPayment(payload) {
            $.ajax({
                url: "{% url 'verifyKhaltiPayment' %}",
                type: "POST",
                data: payload,
                dataType: "json",
                success: function (response) {
                    alert(response);
                },
                error: function (error) {
                    alert(error.responseJSON['message']);
                }
            });
        }

        var config = {

            "publicKey": "test_public_key_7a4bfd8310cc4e9589225ab50f012809",
            "productIdentity": "1234567890",
            "productName": "Dragon",
            "productUrl": "http://gameofthrones.wikia.com/wiki/Dragons",
            "paymentPreference": [
                "KHALTI",
                "EBANKING",
                "MOBILE_BANKING",
                "CONNECT_IPS",
                "SCT",
            ],
            "eventHandler": {
                onSuccess(payload) {
                    // hit merchant api for initiating verfication
                    console.log(payload);
                    verifyKhaltiPayment(payload);
                },
                onError(error) {
                    console.log(error);
                },
                onClose() {
                    console.log('widget is closing');
                }
            }
        };

        var checkout = new KhaltiCheckout(config);
        var btn = document.getElementById("payment-button");
        btn.onclick = function () {
            checkout.show({amount: 1000});
        }

    </script>



{% endblock %}

{% block payment_gateway %}


    <!-- Include the PayPal JavaScript SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=AQJZY0dJWqklH8xQkB7Xqr8yofUgeWx7B8nOC24AJZkcWORVSipavFv9BIgoYNBanevSorPaz2pZwIMw&currency=USD"></script>

    <script>
        // Render the PayPal button into #paypal-button-container
        paypal.Buttons({

            // Set up the transaction
            createOrder: function (data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: '{{ total_amount }}'
                        }
                    }]
                });
            },

            // Finalize the transaction
            onApprove: function (data, actions) {
                return actions.order.capture().then(function (details) {
                    // Show a success message to the buyer
                    var toastMixinn = Swal.mixin({
                        toast: true,
                        icon: 'success',
                        title: '' + data.course_price + ' added successfully',
                        animation: false,
                        position: 'top',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.addEventListener('mouseenter', Swal.stopTimer)
                            toast.addEventListener('mouseleave', Swal.resumeTimer)
                        }
                    });
                    toastMixinn.fire({
                        animation: true,
                        title: 'Transaction completed by ' + details.payer.name.given_name + '!, redirecting you to orders page'
                    });
                    setTimeout(() => {
                        $("#myCartForm").submit();
                    }, 5000);
                });
            }

        }).render('#paypal-button-container');
    </script>

{% endblock %}